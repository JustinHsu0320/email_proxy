# .docker/docker-compose.tmp.yml
# 郵件代理系統臨時環境 (TMP Environment)
#
# 本地服務: postgresql, api, worker, smtp-receiver
# 外部服務: keydb, rabbitmq (連線 MIS 既有)

version: '3.8'

networks:
  # 內部網路：本地服務間通訊
  mail-proxy-internal:
    driver: bridge
    ipam:
      driver: default
      config:
        - subnet: 172.28.0.0/16
  # 外部網路：連接 MIS 既有服務
  # mail-proxy-external:
  #   external: true
  #   name: ${EXTERNAL_NETWORK_NAME:-mis-network}

services:
  # ============================================
  # PostgreSQL 資料庫
  # 正式環境規格：提高記憶體與 CPU 限制
  # ============================================
  postgresql:
    image: postgres:15-alpine
    container_name: mail-proxy-postgresql-tmp
    hostname: postgresql
    restart: always
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
      # PostgreSQL 正式環境優化參數
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      # 連線設定
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgresql_data:/var/lib/postgresql/data
      - ../migrations:/docker-entrypoint-initdb.d:ro
      # PostgreSQL 設定檔（可選）
      - ./postgresql/conf.d:/etc/postgresql/conf.d:ro
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    networks:
      - mail-proxy-internal
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '1.0'
          memory: 1G
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ============================================
  # API 服務
  # 正式環境規格：提高資源限制與完整配置
  # ============================================
  api:
    build:
      context: ..
      dockerfile: .docker/api/Dockerfile
      args:
        BUILD_ENV: production
    image: mail-proxy-api:${IMAGE_TAG:-latest}
    container_name: mail-proxy-api-tmp
    hostname: api
    restart: always
    environment:
      # 基本設定
      - APP_ENV=${APP_ENV}
      - API_PORT=${API_PORT:-8080}
      - GIN_MODE=${GIN_MODE:-release}

      # 資料庫連線 (本地 PostgreSQL)
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/${POSTGRES_DB}?sslmode=disable
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-50}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-10}
      - DATABASE_CONN_MAX_LIFETIME=${DATABASE_CONN_MAX_LIFETIME:-300}

      # RabbitMQ 連線 (MIS 既有)
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      - MAIL_QUEUE_NAME=${MAIL_QUEUE_NAME:-mail-queue}

      # KeyDB 連線 (MIS 既有)
      - KEYDB_URL=${KEYDB_HOST}:${KEYDB_PORT}
      - KEYDB_PASSWORD=${KEYDB_PASSWORD:-}
      - KEYDB_STATUS_TTL_DAYS=${KEYDB_STATUS_TTL_DAYS}

      # Microsoft OAuth 2.0
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}

      # 附件設定
      - ATTACHMENT_PATH=/app/attachments
      - MAX_ATTACHMENT_SIZE_MB=${MAX_ATTACHMENT_SIZE_MB}

      # JWT 認證
      - JWT_SECRET=${JWT_SECRET}

      # Admin Token 初始化
      - INIT_ADMIN_TOKEN=${INIT_ADMIN_TOKEN:-true}
      - ADMIN_TOKEN_NAME=${ADMIN_TOKEN_NAME:-MIS Admin TMP}

      # 日誌設定
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}
    volumes:
      - ${ATTACHMENT_VOLUME_PATH}:/app/attachments
      # 日誌輸出（可選）
      - api_logs:/app/logs
    ports:
      - "${API_PORT:-8080}:8080"
    networks:
      - mail-proxy-internal
      # - mail-proxy-external
    depends_on:
      postgresql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================
  # Worker 服務
  # 正式環境規格：提高並行處理能力
  # ============================================
  worker:
    build:
      context: ..
      dockerfile: .docker/worker/Dockerfile
      args:
        BUILD_ENV: production
    image: mail-proxy-worker:${IMAGE_TAG:-latest}
    container_name: mail-proxy-worker-tmp
    hostname: worker
    restart: always
    environment:
      # 基本設定
      - APP_ENV=${APP_ENV}

      # 資料庫連線 (本地 PostgreSQL)
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/${POSTGRES_DB}?sslmode=disable
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-50}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-10}
      - DATABASE_CONN_MAX_LIFETIME=${DATABASE_CONN_MAX_LIFETIME:-300}

      # RabbitMQ 連線 (MIS 既有)
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      - MAIL_QUEUE_NAME=${MAIL_QUEUE_NAME:-mail-queue}

      # KeyDB 連線 (MIS 既有)
      - KEYDB_URL=${KEYDB_HOST}:${KEYDB_PORT}
      - KEYDB_PASSWORD=${KEYDB_PASSWORD:-}
      - KEYDB_STATUS_TTL_DAYS=${KEYDB_STATUS_TTL_DAYS}

      # Microsoft OAuth 2.0
      - MICROSOFT_TENANT_ID=${MICROSOFT_TENANT_ID}
      - MICROSOFT_CLIENT_ID=${MICROSOFT_CLIENT_ID}
      - MICROSOFT_CLIENT_SECRET=${MICROSOFT_CLIENT_SECRET}

      # SendGrid (非組織網域)
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - ORG_EMAIL_DOMAIN=${ORG_EMAIL_DOMAIN}

      # 附件設定
      - ATTACHMENT_PATH=/app/attachments
      - MAX_ATTACHMENT_SIZE_MB=${MAX_ATTACHMENT_SIZE_MB}

      # Worker 設定 (正式環境提高並行數)
      - WORKER_CONCURRENCY=${WORKER_CONCURRENCY}
      - WORKER_PREFETCH=${WORKER_PREFETCH}
      - MAX_RETRY_COUNT=${MAX_RETRY_COUNT}

      # 日誌設定
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}
    volumes:
      - ${ATTACHMENT_VOLUME_PATH}:/app/attachments
      # 日誌輸出（可選）
      - worker_logs:/app/logs
    networks:
      - mail-proxy-internal
      # - mail-proxy-external
    depends_on:
      postgresql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

  # ============================================
  # SMTP Inbound Server 服務
  # 接收外部 SMTP 郵件並轉發到 RabbitMQ
  # 正式環境規格：啟用 TLS 與認證
  # ============================================
  smtp-receiver:
    build:
      context: ..
      dockerfile: .docker/smtp-receiver/Dockerfile
      args:
        BUILD_ENV: production
    image: mail-proxy-smtp-receiver:${IMAGE_TAG:-latest}
    container_name: mail-proxy-smtp-receiver-tmp
    hostname: smtp-receiver
    restart: always
    environment:
      # 基本設定
      - APP_ENV=${APP_ENV}

      # 資料庫連線 (本地 PostgreSQL)
      - DATABASE_URL=postgres://${POSTGRES_USER}:${POSTGRES_PASSWORD}@postgresql:5432/${POSTGRES_DB}?sslmode=disable
      - DATABASE_MAX_OPEN_CONNS=${DATABASE_MAX_OPEN_CONNS:-25}
      - DATABASE_MAX_IDLE_CONNS=${DATABASE_MAX_IDLE_CONNS:-5}
      - DATABASE_CONN_MAX_LIFETIME=${DATABASE_CONN_MAX_LIFETIME:-300}

      # RabbitMQ 連線 (MIS 既有)
      - RABBITMQ_URL=amqp://${RABBITMQ_USER}:${RABBITMQ_PASSWORD}@${RABBITMQ_HOST}:${RABBITMQ_PORT}/
      - MAIL_QUEUE_NAME=${MAIL_QUEUE_NAME:-mail-queue}

      # KeyDB 連線 (MIS 既有)
      - KEYDB_URL=${KEYDB_HOST}:${KEYDB_PORT}
      - KEYDB_PASSWORD=${KEYDB_PASSWORD:-}
      - KEYDB_STATUS_TTL_DAYS=${KEYDB_STATUS_TTL_DAYS}

      # 附件設定
      - ATTACHMENT_VOLUME_PATH=/app/attachments
      - MAX_ATTACHMENT_SIZE_MB=${MAX_ATTACHMENT_SIZE_MB}

      # SMTP 伺服器設定 (正式環境)
      - SMTP_INBOUND_PORT=${SMTP_INBOUND_PORT:-2525}
      - SMTP_INBOUND_TLS_PORT=${SMTP_INBOUND_TLS_PORT:-1587}
      - SMTP_TLS_ENABLED=${SMTP_TLS_ENABLED:-true}
      - SMTP_TLS_CERT_FILE=${SMTP_TLS_CERT_FILE:-/app/certs/server.crt}
      - SMTP_TLS_KEY_FILE=${SMTP_TLS_KEY_FILE:-/app/certs/server.key}
      - SMTP_AUTH_REQUIRED=${SMTP_AUTH_REQUIRED:-true}
      - SMTP_ALLOWED_DOMAINS=${SMTP_ALLOWED_DOMAINS}
      - SMTP_MAX_MESSAGE_SIZE_MB=${SMTP_MAX_MESSAGE_SIZE_MB:-50}

      # JWT 認證
      - JWT_SECRET=${JWT_SECRET}

      # 日誌設定
      - LOG_LEVEL=${LOG_LEVEL:-info}
      - LOG_FORMAT=${LOG_FORMAT:-json}
    volumes:
      - ${ATTACHMENT_VOLUME_PATH}:/app/attachments
      # TLS 憑證（正式環境必要）
      - ${SMTP_TLS_CERT_PATH:-./certs}:/app/certs:ro
      # 日誌輸出（可選）
      - smtp_receiver_logs:/app/logs
    ports:
      - "${SMTP_INBOUND_PORT:-2525}:2525"
      - "${SMTP_INBOUND_TLS_PORT:-1587}:1587"
    networks:
      - mail-proxy-internal
      # - mail-proxy-external
    depends_on:
      postgresql:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "10"

volumes:
  # PostgreSQL 資料持久化
  postgresql_data:
    driver: local
  # 日誌持久化
  api_logs:
    driver: local
  worker_logs:
    driver: local
  smtp_receiver_logs:
    driver: local
